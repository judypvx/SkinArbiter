# SkinArbiter

# Проект: Telegram-бот для арбитража скинов

## Идея проекта
Создать Telegram-бота для арбитража скинов, который покупает скины на одной площадке (Market.CSGO) и продаёт их на другой (Waxpeer) с целью получения прибыли. Бот будет анализировать предметы (CS:GO, Dota 2, Rust, CS2), учитывать ликвидность, автоматически регулировать профит и уведомлять пользователя о сделках через Telegram.

## Архитектура
Проект разбит на несколько независимых модулей, которые взаимодействуют асинхронно через очереди сообщений:
- **Core Bot Service (Telegram Bot + FastAPI):**
  - Базовый функционал взаимодействия с пользователем (команды, кнопки).
  - Работа с конфигурацией и настройками через Telegram.
- **Trade Executor Service:**
  - Алгоритмы поиска арбитражных возможностей.
  - Обработка сделок через внешние API (Market.CSGO и Waxpeer).
  - Динамическое изменение профита.
- **Item Tracker Service:**
  - Хеширование предметов, хранение истории цен.
  - Анализ трендов, подсчёт стоимости наклеек и брелков (для CS2).
- **Notification Service:**
  - Формирование и отправка уведомлений с подробной аналитикой (фото, цены, профит).
- **Steam Trade Manager Service (Node.js):**
  - Подтверждение трейдов, генерация 2FA-кодов для Steam.
  - Обработка входящих trade offer-ов.

## Технологический стек
- **Язык программирования:** Python (aiogram, FastAPI) и Node.js.
- **База данных:** MongoDB для хранения данных, Redis для кэширования и очередей.
- **Очереди сообщений:** RabbitMQ для асинхронных задач.
- **Контейнеризация и оркестрация:** Docker + Kubernetes.
- **Мониторинг и логирование:** Prometheus + Grafana, ELK Stack (Elasticsearch, Logstash, Kibana).

## Стратегия разработки
Проект разделен на 5 этапов:
1. **Этап 1: Базовый функционал Telegram-бота**
   - Инициализация проекта, создание базовых команд и кнопок.
   - Подключение MongoDB, базовое логирование и контейнеризация.
2. **Этап 2: Расширенная логика и работа с данными**
   - Сохранение и обработка пользовательских настроек.
   - Команды для администрирования (например, `/logs`).
3. **Этап 3: Интеграция с API Market.CSGO и Waxpeer**
   - Получение данных с внешних сервисов, WebSocket-листенеры.
4. **Этап 4: Автоматизация сделок и распределение нагрузки**
   - Реализация автоматической обработки сделок через RabbitMQ.
   - Поддержка нескольких Steam-аккаунтов, резервное копирование.
5. **Этап 5: Steam Trade Manager (Node.js)**
   - Автоматизация подтверждения трейдов в Steam, генерация 2FA-кодов.

## Организация работы
Мы будем использовать Notion для управления задачами в виде канбан-доски с колонками:
- **To Do:** Задачи, которые предстоит выполнить.
- **In Progress:** Задачи, над которыми ведется работа.
- **Review / Testing:** Готовые задачи, требующие проверки.
- **Done:** Завершенные задачи.

Каждая задача будет иметь поля: Название, Описание, Приоритет, Этап, Срок выполнения и ответственного.


``markdown
# Описание Telegram-бота для арбитража скинов (Обновлён)

---

## 1. Описание проекта

Оледжи хочет создать **Telegram-бота для арбитража скинов**, который:

- Покупает скины на одной площадке и продаёт на другой с целью получения прибыли.
- Выполняет **круговой процесс арбитража**:
  - Покупка на Market.CSGO → Продажа на Waxpeer → Покупка на Waxpeer → Продажа на Market.CSGO → повтор.
- Анализирует предметы для CS:GO, Dota 2, Rust и теперь CS2 (с подсчётом стоимости брелков) с отдельными фильтрами и настройками.
- Учитывает ликвидность предметов на площадке продажи.
- Обеспечивает максимальную автоматизацию с гибкими настройками через Telegram.
- Поддерживает несколько Steam-аккаунтов и резервное копирование данных.
- Отправляет уведомления в Telegram с подробной аналитикой по каждой сделке.

---

## 2. Какие площадки используются

1. **Market.CSGO (csgo.tm)**
   - Высокий объём продаж и ликвидность.
   - WebSocket API для мониторинга лотов в реальном времени.
   - Удобное и гибкое API с возможностью фильтрации данных.
   - **API:** [Market.CSGO API](https://market.csgo.com/en/api)
     - Поддержка WebSocket для отслеживания изменений цен и лотов.

2. **Waxpeer**
   - WebSocket API для мониторинга в реальном времени.
   - Хорошая ликвидность и стабильный объём продаж.
   - Поддержка покупки и продажи скинов через API.
   - **API:** [Waxpeer API](https://docs.waxpeer.com/?method=v1-merchant-user-post)
     - Поддержка WebSocket для получения обновлений о лотах.

---

## 3. Основные функции Telegram-бота

### 3.1 Покупка и продажа скинов

- Круговой процесс арбитража: Market.CSGO → Waxpeer → Market.CSGO → повтор.
- Фильтрация лотов по параметрам:
  - Процент профита.
  - Диапазон цен.
  - Ликвидность (количество продаж в неделю).
  - Наценки за наклейки (и теперь за брелки в CS2).
- **Dump Protection** – защита от падения цен с настройкой порога (-5%, -10%, -15%) и автоматическим снижением цены для минимизации убытков.

### 3.2 Динамическое изменение профита

- Автоматическая корректировка профита в зависимости от скорости продаж.
- Настройка агрессивности (Aggressive / Moderate / Passive).
- Повышение профита при высоком спросе и его снижение при низком спросе.

### 3.3 Анализ конкурентов

- Мониторинг цен конкурентов на той же площадке.
- Автоматическая корректировка цены для повышения конкурентоспособности с настройкой агрессивности.

### 3.4 Модуль анализа трендов (Trend Analysis)

- Анализ динамики цен за определённый период.
- Пометка предметов с восходящим/нисходящим трендом.
- Фильтрация предметов с падающим трендом перед покупкой.
- Игнорирование предметов с частыми скачками цен.
- Настройка в Telegram Bot для игнорирования падающих трендов.

### 3.5 Подсчёт стоимости наклеек и брелков

- Подсчёт стоимости всех наклеек на оружии (если не сувенирное) с последующей наценкой:
  - 1 наклейка от $10 – наценка 5%
  - 2 наклейки – наценка 10%
  - 3 наклейки – наценка 15%
  - 4 наклейки – наценка 20%
  - 5 наклеек – наценка 25%
- **Новый функционал для CS2:**
  - Подсчёт стоимости брелка на оружии CS2.
  - Наценка 30% от стоимости брелка (значение можно корректировать через Telegram Bot).
- Настройка в Telegram Bot для включения/выключения и изменения процентов наценки.

### 3.6 Обновлённые уведомления в Telegram

- Уведомления о купленных лотах включают:
  - Фото предмета.
  - Название предмета.
  - Цена покупки.
  - Площадка покупки.
  - Цена продажи, от которой рассчитывается процент профита.
  - Площадка продажи.
  - Фактический профит (разница между ценой покупки и продажей).
  - Ожидаемый профит (с учётом комиссии и динамики цен).
- Настройка уведомлений в Telegram Bot для включения/выключения расширенных данных.

### 3.7 Поддержка нескольких аккаунтов Steam

- Автоматическое считывание всех maFile из папки `maFiles/` (название файла может быть любым).
- Автоматическое распределение трейдов между аккаунтами.
- Использование `shared_secret` и `identity_secret` для генерации 2FA кодов и подтверждения трейдов.
- Команда `/accounts` для отображения баланса и статуса всех аккаунтов.

### 3.8 Автоматическое резервное копирование (Backup)

- Резервное копирование базы данных MongoDB и конфигурационных файлов (`config.yaml`, `db_config.yaml`).
- Хранение бэкапов в папке `/backups/` с автоматическим удалением старых файлов.
- Уведомления в Telegram о результатах резервного копирования.
- Настройка частоты и срока хранения бэкапов через Telegram Bot.

---

## 4. Структура проекта

Бот состоит из 6 основных модулей и 4 дополнительных, с учётом обновлений:

1. **Telegram Bot (Core Controller)** – управление и настройки через Telegram.
2. **WebSocket Listener** – мониторинг лотов в реальном времени через WebSocket.
3. **Trade Executor** – покупка и продажа предметов с динамическим профитом и защитами.
4. **Item Tracker** – хеширование, отслеживание состояния предметов, история цен и подсчёт стоимости наклеек/брелков.
5. **Steam Trade Manager (Node.js)** – подтверждение трейдов и генерация 2FA кодов через maFile.
6. **Notification Manager** – расширенные уведомления о покупках, продажах, аналитика и подтверждения трейдов.

**Продолжение в следующих разделах...**

---

## 5. Подробная структура проекта

### 5.1 Telegram Bot (Core Controller)

**Описание:**

- Основной модуль для управления ботом через команды и кнопки в Telegram.
- Настройка параметров арбитража: профит, диапазоны цен, ликвидность, наценки за наклейки/брелки.
- Управление мультиаккаунтностью и анализом трендов.
- Обновление конфигурации в реальном времени.
- Поддержка CS:GO, Dota 2, Rust и CS2 с отдельными настройками и фильтрами.

**Основные функции:**

- Управление закупками и продажами на Market.CSGO и Waxpeer (отдельно для каждой игры).
- Настройка параметров (процент профита, диапазоны цен, минимальное количество продаж в неделю, динамическое изменение профита, анализ конкурентов, наценки).
- Поддержка нескольких аккаунтов Steam (команда `/accounts` для отображения баланса и статуса).
- Модуль анализа трендов – включение/отключение и фильтрация предметов с падающим трендом.
- Обновление конфигурации через команду `/reload` без перезапуска бота.

**Структура:**

```plaintext
core_controller/
│
├── bot.py                   # Основная логика бота и обработка команд
└── handlers/
    ├── start.py             # Обработка команды /start и приветствие
    ├── settings.py          # Управление настройками (профит, цены, игры, ликвидность)
    ├── balance.py           # Управление балансом и уведомлениями
    ├── guard.py             # Управление подтверждениями и 2FA
    ├── accounts.py          # Поддержка нескольких аккаунтов Steam
    ├── trend_analysis.py    # Управление анализом трендов
    └── reload.py            # Обновление конфигурации в реальном времени
```

---

### 5.2 WebSocket Listener

**Описание:**

- Мониторинг лотов в реальном времени через WebSocket для Market.CSGO и Waxpeer.
- Фильтрация лотов по параметрам профита, диапазону цен и ликвидности.
- Оптимизация запросов с использованием Redis и анти-Ban система с прокси.
- Поддержка анализа предметов для CS:GO, Dota 2, Rust и CS2.

**Структура:**

```plaintext
websocket_listener/
│
├── listener_market.py       # Подключение к WebSocket Market.CSGO
├── listener_waxpeer.py      # Подключение к WebSocket Waxpeer
├── listener_dota2.py        # Анализ лотов для Dota 2
├── listener_rust.py         # Анализ лотов для Rust
└── filters.py               # Фильтрация лотов по профиту, ценам и ликвидности
└── anti_ban.py              # Анти-Ban система и прокси
```

---

### 5.3 Trade Executor

**Описание:**

- Реализует покупку и продажу предметов с учётом динамического профита, Dump Protection, анализа конкурентов и управления балансом.
- Связывает Market.CSGO и Waxpeer для арбитража.
- Поддерживает отдельные модули для CS:GO, Dota 2, Rust (и CS2, косвенно через обновлённый Item Tracker).

**Структура:**

```plaintext
trade_executor/
│
├── executor_market_to_waxpeer.py  # Покупка на Market.CSGO, продажа на Waxpeer
├── executor_waxpeer_to_market.py  # Покупка на Waxpeer, продажа на Market.CSGO
├── executor_dota2.py             # Покупка и продажа предметов для Dota 2
├── executor_rust.py              # Покупка и продажа предметов для Rust
├── dynamic_profit.py             # Динамическое изменение профита
├── competitor_analysis.py        # Анализ конкурентов
├── dump_protection.py            # Защита от падения цен
└── balance_management.py         # Управление балансом
```

---

### 5.4 Item Tracker

**Описание:**

- Хеширование и отслеживание состояния предметов (куплен, ожидание трейда, готов к продаже, продан).
- Хранение истории цен в MongoDB для Dump Protection.
- Анализ трендов и динамики цен.
- Подсчёт стоимости наклеек с наценкой и теперь подсчёт стоимости брелков для CS2.
- Автоматическое резервное копирование данных.

**Обновлённые функции для CS2:**

- Модуль для подсчёта стоимости брелков `keychain_cs2.py`:
  - Определение стоимости брелка на оружии.
  - Применение наценки 30% (значение можно корректировать через Telegram Bot).

**Структура:**

```plaintext
item_tracker/
│
├── tracker.py                # Хеширование и отслеживание состояния предметов
├── price_history.py          # История цен (для защиты от падения цен)
├── trend_analysis.py         # Анализ трендов
├── backup.py                 # Резервное копирование данных
├── stickers.py               # Подсчёт стоимости наклеек и наценка (для CS:GO, Dota2, Rust)
├── keychain_cs2.py           # Подсчёт стоимости брелков для CS2 (новый модуль)
├── tracker_dota2.py          # Анализ предметов для Dota 2
└── tracker_rust.py           # Анализ предметов для Rust
```

---

### 5.5 Steam Trade Manager (Node.js)

**Описание:**

- Подтверждение входящих и исходящих трейдов с использованием maFile.
- Генерация 2FA кодов с использованием `shared_secret` и `identity_secret`.
- Поддержка нескольких Steam-аккаунтов, автоматическое считывание maFile из папки `maFiles/`.
- Использование данных сессии для работы с API Steam.

**Структура:**

```plaintext
steam_trade_manager/
│
├── trade_manager.js          # Основная логика подтверждения трейдов
├── steam_guard.js            # Генерация 2FA кодов с использованием maFile
└── maFiles/                  # Хранение maFile (названия файлов могут быть любыми)
    └── example1.maFile
    └── example2.maFile
```

---

### 5.6 Notification Manager

**Описание:**

- Отправка уведомлений в Telegram о покупках, продажах, подтверждениях трейдов, аналитике и 2FA кодах.
- Расширенные уведомления включают:
  - Фото предмета.
  - Название предмета.
  - Цену покупки и площадку, где он куплен.
  - Цену продажи (на основе которой рассчитывается процент профита) и площадку продажи.
  - Фактический профит и ожидаемый профит (с учётом комиссии и динамики цен).
- Настройка уведомлений через Telegram Bot для включения/выключения расширенных данных.

**Структура:**

```plaintext
notification_manager/
│
├── notifier.py               # Основной модуль уведомлений (обновлён: включает фото и расширенные данные)
├── analytics.py              # Сбор аналитики и логирование
├── backup_notifier.py        # Уведомления о бэкапах
├── notifier_csgo.py          # Уведомления для CS:GO (расширенные)
├── notifier_dota2.py         # Уведомления для Dota 2
└── notifier_rust.py          # Уведомления для Rust
```

---

## 6. База данных и кэширование

### 6.1 MongoDB

- Хранение данных о предметах, истории цен, аналитики и логов.
- Основные коллекции:
  - `items` – данные о предметах (название, цена покупки, цена продажи, состояние, наклейки, брелки для CS2).
  - `price_history` – история цен для каждого предмета.
  - `trades` – информация о подтверждённых трейдах.
  - `analytics` – данные о прибыльности, скорости продаж и динамике цен.
  - `accounts` – данные о подключённых Steam-аккаунтах.
  - `notifications` – логи отправленных уведомлений.
  - `backups` – информация о бэкапах и их статусе.

### 6.2 Redis

- Кэширование данных для оптимизации запросов к API.
- Хранение временных данных для анти-Ban системы.
- Обмен данными между модулями (с использованием Socket.io между Python и Node.js).

**Структура:**

```plaintext
shared/
│
├── db.py                     # Подключение к MongoDB и Redis
└── utils.py                  # Вспомогательные функции
```

---

## 7. Конфигурационные файлы и настройки

### 7.1 config.yaml

- Основные настройки бота:
  - Процент профита, диапазоны цен.
  - Настройки ликвидности (количество продаж в неделю).
  - Динамическое изменение профита и анализ конкурентов.
  - Настройка наценок за наклейки и брелки.
  - Настройки анализа трендов.
  - Поддержка CS:GO, Dota 2, Rust и CS2 (отдельные настройки для брелков в CS2).

### 7.2 db_config.yaml

- Настройки подключения к MongoDB и Redis.
  - **MongoDB:** хранение данных о предметах, истории цен, аналитики и логов.
  - **Redis:** кэширование данных и обмен информацией между модулями.

### 7.3 .env

- Чувствительные данные и токены:
  - Telegram Bot Token.
  - API ключи для Market.CSGO и Waxpeer.
  - Данные подключения к MongoDB и Redis.
  - Прокси для анти-Ban системы.

**Структура:**

```plaintext
config/
│
├── config.yaml              # Основные настройки (профит, цены, ликвидность, наценки)
└── db_config.yaml           # Настройки подключения к MongoDB и Redis
.env                          # Чувствительные данные и токены
```

---

## 8. Технологии и сервисы

### 8.1 Языки программирования

- **Python** – основной функционал Telegram-бота и модулей.
- **Node.js** – для Steam Trade Manager (подтверждение трейдов и генерация 2FA кодов).

### 8.2 Базы данных

- **MongoDB** – хранение данных о предметах, истории цен, хеширование предметов.
- **Redis** – кэширование данных и обмен информацией между модулями.

### 8.3 API и библиотеки

- **Telegram Bot API (aiogram)** – управление ботом.
- **WebSocket API** – мониторинг лотов в реальном времени.
- **Steam API (steamcommunity, steam-tradeoffer-manager, steam-totp)** – работа с трейдами и 2FA.
- **Socket.io** – связь между Python и Node.js.

### 8.4 Хостинг и развёртывание

- **Docker** – контейнеризация модулей.
- **Kubernetes** – оркестрация контейнеров.
- **CI/CD (GitHub Actions)** – автоматическое развёртывание обновлений.
- **VPS (DigitalOcean или Hetzner)** – хостинг.



